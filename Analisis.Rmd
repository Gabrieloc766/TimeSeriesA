---
title: "Analisis Tasa de Intervencion"
author: "Gabriel Orozco Castaño"
date: "2024-10-15"
output: html_document
---

#1 Enunciado:

En este momento deberemos retomar la Unidad 1 en la cual se creó un minilibro que contiene el entregable de dicha unidad. Este documento tiene como repositorio GitHub (elaborado desde Markdown). Ahora, en esta Unidad 2, se debe continuar con los datos presentados en dicho entregable y se debe evidenciar, en una de las variables en el tiempo, la aproximación en promedio móvil, en rezagos y en estacionalidad. Todo lo anterior, a través de funciones y gráficas que permitan detectar patrones y ciclos de la variable.

# 2 Análisis exploratorio:

```{r echo=FALSE, message=FALSE}
#install.packages("readxl")
#install.packages("forecast")
#install.packages("timsac")
#install.packages("changepoint")
#install.packages("kableExtra")


library(readxl)
library(forecast) # Recomendada profesora
library(ggplot2)
library(tseries) # Recomendada profesora
library(timsac)
library(changepoint)
library(dplyr)
library(lubridate)
library(tidyr)
library(kableExtra)
library(knitr)
library(zoo)
library(scales)


```

```{r echo=FALSE}
data <- read_excel("1.2.TIP_Serie historica diaria.xlsx")
```


```{r echo=FALSE}
str(data)
```

Los datos representan una serie de tiempo de 310 filas y 2 columnas, correspondientes a la fecha y a la tasa. Se observa que la fecha realmente corresponde a un dato mensual por tanto conviene ajustar el formato.


```{r echo=FALSE}
# Primer y último registro del dataset
resultado <- rbind(head(data, 1), tail(data, 1))
print(resultado)

```
Al consultar el primer y último registro del dataset, se identifica que la observación más reciente corresponde al mes de octubre de 2024 con una tasa de 10.25%, mientras que el registro más antiguo es de enero de 1999, con una tasa de 26%. Estos datos indican que el dataset abarca un periodo de aproximadamente 25 años (310 meses), desde finales del siglo XX hasta la fecha actual, reflejando un amplio intervalo temporal que podría incluir distintas tendencias o cambios económicos en la variable Tasa.

```{r echo=FALSE}
summary(data)
```

* La serie cubre un rango de 25 años, con la mediana alrededor de 2011, lo que sugiere que los datos están relativamente bien distribuidos a lo largo del tiempo.
*  La tasa tiene una amplia variabilidad, con un valor mínimo de 1.75 y un máximo de 26. La mayor parte de los valores se concentran entre 4.25 y 9.25 (entre el primer y tercer cuartil). 

```{r echo=TRUE}
n_nas_por_columna <- colSums(is.na(data))
print(n_nas_por_columna)
```
No se identifican datos ausentes.



```{r echo=FALSE}
data2 <- data

```

Con el código siguiente, se agregan dos columnas adicionales, llamadas Año y Mes, lo anterior para poder tener una mejor visual de los datos, teniendo en cuenta el gran número de registros que tiene el dataset.


```{r echo=FALSE}


data2 <- data2 %>%
  mutate(Fecha = as.Date(Fecha), Anio = year(Fecha), Mes = month(Fecha, label = TRUE, abbr = TRUE)) %>%
  select(Anio, Mes, everything())

head(data2)


```

# 3. Gráficos de visualización:


```{r echo=FALSE}
ggplot(data2, aes(x = Fecha, y = Tasa)) +
  geom_point(color = "blue", size = 2) + 
  geom_smooth(method = "loess", color = "red", se = FALSE) +  
  labs(title = "Tasa a lo largo del tiempo",
       x = "Tiempo",
       y = "Tasa") +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "1 month") +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "lightgrey"),
    panel.grid.minor = element_blank()
  )

```

* **Puntos Azules:** Los puntos azules indican los valores de "Tasa" en momentos específicos. Hay una dispersión considerable, sugiriendo que la tasa ha experimentado fluctuaciones a lo largo del tiempo.

* **Línea Roja:** Esta línea es el resultado de un ajuste de suavización (usando el método LOESS, como se especificó en tu código). La línea roja ilustra la tendencia general de la "Tasa" a lo largo del tiempo. A partir de la línea, se puede observar que, aunque hay variaciones, existe una tendencia que se puede analizar para hacer predicciones o entender mejor el comportamiento de la variable.

* **Variaciones:** La gráfica muestra que la Tasa ha tenido picos y valles, lo que podría indicar variaciones estacionales o influencias externas que afectan la variable a lo largo del tiempo. A partir de la línea de suavización, parece que la Tasa ha ido disminuyendo o estabilizándose en ciertos períodos, teniendo una caída significativa desde 1999 hasta 2003,  y un aumento importante de 2021 a 2024.


```{r echo=FALSE}


data2 <- data2 %>%
  mutate(Fecha = as.Date(Fecha))

ggplot(data2, aes(x = Anio, y = Tasa)) +
  geom_point(color = "blue", size = 2) +  # Puntos en azul
  geom_line(color = "blue", size = 1) +  # Línea azul
  geom_smooth(method = "loess", color = "red", se = FALSE) +  # Tendencia en rojo
  labs(title = "Tasa a lo largo del tiempo",
       x = "Anio",
       y = "Tasa") +
  scale_x_continuous(breaks = seq(min(data2$Anio), max(data2$Anio), by = 2)) +  # Eje X de 2 en 2
  scale_y_continuous(breaks = seq(min(data2$Tasa, na.rm = TRUE), max(data2$Tasa, na.rm = TRUE), by = 2)) +  # Eje Y de 2 en 2
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "lightgrey")
  )

```


Esta gráfica permite ver con más detalle los cambios de tendencia:

* Desde 1999, se confirma la disminución significativa en la tasa, que empieza muy alta (cerca de 25) y cae rápidamente hasta estabilizarse alrededor de los años 2007-2008 en un valor muy inferior (por debajo de 10).

* Entre 2005 y 2020, se observan picos y caídas a intervalos relativamente regulares, pero sin grandes cambios en los niveles generales hasta el repunte final.

* Eentre 2010 y 2020, la tasa se mantiene más estable, con algunas oscilaciones en torno a los 5-10 puntos.

* A partir de 2021, hay una tendencia de aumento, que se hace más pronunciada hacia los años más recientes.  Esto podría ser consecuencia de algún cambio en las políticas o factores externos como la pandemia de COVID-19.

* La línea de tendencia suavizada indica una caída rápida, seguida de un periodo de estabilización, y finalmente una tendencia de aumento en los años recientes, semejando una forma de "U" suavizada.



```{r echo=FALSE}

data2 <- data2 %>%
  mutate(Fecha = as.Date(Fecha)) 

# Agregar las columnas Año y Mes
data2 <- data2 %>%
  mutate(
    Anio = year(Fecha),
    Mes = month(Fecha, label = TRUE, abbr = TRUE)  
  )

# Crear la tabla de tasas por Año y Mes
tabla_tasas <- data2 %>%
  group_by(Anio, Mes) %>%
  summarise(TasaPromedio = round(mean(Tasa, na.rm = TRUE), 1)) %>%  
  pivot_wider(names_from = Mes, values_from = TasaPromedio)  

# Mostrar la tabla en cuadrícula
kable(tabla_tasas, format = "html") %>%
  kable_styling(full_width = F, position = "left")


```




# 4. Análisis de serie de tiempo:

## 4.1. Promedio o media móvil

Permite analizar el mercado a través de las tendencias. La media móvil es una técnica estadística que se utiliza para analizar datos a lo largo del tiempo. Permite calcular la media de un conjunto de valores en un intervalo específico y luego desplazar ese intervalo a lo largo de la serie de datos para obtener una nueva serie de medias; lo que permite suavizar fluctuaciones en los datos así como resaltar tendencias.

Se conoce como media móvil ya que el valor se calcula constantemente a medida que pasa el tiempo; de esta forma, la media cambia cada vez que los valores cambian.


```{r echo=FALSE}
# Calcular el promedio móvil
data2$PromedioMovil <- rollmean(data2$Tasa, k = 3, fill = NA, align = "right")

# Visualizar la tasa original y el promedio móvil
ggplot(data2) +
  geom_line(aes(x = Fecha, y = Tasa), color = "blue", size = 1, group = 1) +  # Tasa original
  geom_line(aes(x = Fecha, y = PromedioMovil), color = "red", size = 1, group = 1) +  # Promedio móvil
  labs(title = "Tasa y Promedio Movil a lo largo del tiempo",
       x = "Fecha",
       y = "Tasa") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +  # Eje X de 2 en 2 años
  scale_y_continuous(breaks = seq(0, max(data2$Tasa, na.rm = TRUE), by = 2)) +  # Eje Y de 2 en 2
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "lightgrey"),
    panel.grid.minor = element_blank()
  )


```


## 4.2. Rezago (operador backshift) y estacionalidad


El operador rezago actúa sobre una serie de tiempo



```{r echo=FALSE}


# Aplicar rezago de 1 período 
data2$Tasa_lag1 <- dplyr::lag(data2$Tasa, n = 1)
head(data2)

```  


```{r echo=FALSE}

if (!is.ts(data2)) {
  data2 <- ts(data2)
}

# Verificar si hay valores NA o infinitos
if (any(is.na(data2)) || any(!is.finite(data2))) {
  # Eliminar valores NA
  data2 <- na.omit(data2)
}

# Generar el gráfico de rezago
lag.plot(data2, lags = 3, do.lines = FALSE, main = "Grafico de Rezago")
```



